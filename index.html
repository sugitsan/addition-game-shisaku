<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>たしざんクイズ</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    .problem {
      font-size: 72px;
      margin: 20px;
    }
    .dots {
      font-size: 32px;
      margin: 10px;
      text-align: left;
      white-space: pre-wrap;
    }
    button {
      font-size: 36px;
      padding: 10px 20px;
      margin: 10px;
      background-color: white;
      border: 2px solid #000;
      cursor: pointer;
    }
    .progress-container {
      width: 100%;
      background-color: #eee;
      height: 30px;
      margin-bottom: 20px;
    }
    .progress-bar {
      height: 100%;
      background-color: lightgreen;
      width: 0%;
    }
    .feedback {
      font-size: 32px;
      margin: 20px;
    }
  </style>
</head>
<body>
  <h1>たしざんクイズ</h1>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="dotsArea" class="dots"></div>
  <div class="problem" id="problem">1 + 1 = ?</div>
  <div id="buttons"></div>
  <div class="feedback" id="feedback"></div>

  <audio id="correctSound" src="correct.mp3" preload="auto"></audio>

  <script>
    const totalQuestions = 10;
    let currentQuestion = 0;
    let correctAnswers = 0;
    let startTime = Date.now();

    const problem = document.getElementById('problem');
    const buttonsDiv = document.getElementById('buttons');
    const feedback = document.getElementById('feedback');
    const progressBar = document.getElementById('progressBar');
    const dotsArea = document.getElementById('dotsArea');
    const correctSound = document.getElementById('correctSound');

    function playCorrectSound() {
      // 重複再生可能なようにクローンを使う
      const clone = correctSound.cloneNode();
      clone.play();
    }

    function showProblem() {
      const a = Math.floor(Math.random() * 9) + 1;
      const b = Math.floor(Math.random() * 9) + 1;
      const answer = a + b;

      problem.textContent = `${a} + ${b} = ?`;
      dotsArea.textContent =
        `${a}こ：${'●'.repeat(a).replace(/(.{5})/g, '$1 ')}\n` +
        `${b}こ：${'●'.repeat(b).replace(/(.{5})/g, '$1 ')}`;

      const answers = new Set();
      answers.add(answer);
      while (answers.size < 4) {
        const fake = answer + Math.floor(Math.random() * 5) - 2;
        if (fake > 0) answers.add(fake);
      }

      const shuffled = Array.from(answers).sort(() => Math.random() - 0.5);

      buttonsDiv.innerHTML = '';
      shuffled.forEach(num => {
        const btn = document.createElement('button');
        btn.textContent = num;
        btn.onclick = () => checkAnswer(num, answer, btn);
        buttonsDiv.appendChild(btn);
      });

      feedback.textContent = '';
      updateProgressBar();
    }

    function checkAnswer(selected, correct, selectedButton) {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);

      if (selected === correct) {
        selectedButton.style.backgroundColor = 'lightgreen';
        feedback.textContent = 'せいかい！';
        playCorrectSound();
        correctAnswers++;
        setTimeout(() => {
          currentQuestion++;
          if (currentQuestion < totalQuestions) {
            resetButtons();
            showProblem();
          } else {
            showResult();
          }
        }, 500);
      } else {
        selectedButton.style.backgroundColor = 'pink';
        buttons.forEach(btn => {
          if (parseInt(btn.textContent) === correct) {
            btn.style.backgroundColor = 'lightgreen';
          }
        });
        feedback.textContent = `ざんねん、せいかいは ${correct} です。`;
        setTimeout(() => {
          currentQuestion++;
          if (currentQuestion < totalQuestions) {
            resetButtons();
            showProblem();
          } else {
            showResult();
          }
        }, 3000);
      }
    }

    function resetButtons() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.style.backgroundColor = 'white';
      });
    }

    function updateProgressBar() {
      const percent = (currentQuestion / totalQuestions) * 100;
      progressBar.style.width = `${percent}%`;
    }

    function showResult() {
      const timeTaken = Math.round((Date.now() - startTime) / 1000);
      problem.textContent = '';
      buttonsDiv.innerHTML = '';
      dotsArea.textContent = '';
      let message = `せいかいすう：${correctAnswers} / ${totalQuestions}`;
      if (correctAnswers <= 5) {
        message += '\nつぎも　がんばろう！';
      } else if (correctAnswers <= 8) {
        message += '\nなかなか　やりますね！';
      } else if (correctAnswers === 9) {
        message += '\nおしい、あと１もんでパーフェクト！';
      } else {
        message += '\nすばらしい！かんぺきです！！';
      }
      message += `\nかかったじかん・・・${timeTaken}びょう`;
      feedback.textContent = message;
      progressBar.style.width = '100%';
    }

    showProblem();
  </script>
</body>
</html>
